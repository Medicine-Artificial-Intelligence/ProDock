name: Test & Lint

on:
  push:
    branches: ["refactor", "main", "staging"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

env:
  CONDA_ENV_NAME: prodock-env

jobs:
  build:
    name: Build, lint, test (minimal)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          python-version: 3.11.0

      - name: Install mamba
        run: |
          conda install -n base -c conda-forge mamba -y
        shell: bash -l {0}

      - name: Create minimal conda env (openmm + pdbfixer)
        run: |
          # create env with required binary packages (minimal)
          mamba create -n "${CONDA_ENV_NAME}" -c conda-forge -y \
            python=3.11 openmm=8.3.1 pdbfixer libstdcxx-ng libgcc-ng

          # compute env prefix and publish to GITHUB_ENV so following steps can use it
          CONDA_BASE=$(conda info --base)
          ENV_PREFIX="${CONDA_BASE}/envs/${CONDA_ENV_NAME}"
          echo "ENV_PREFIX=${ENV_PREFIX}" >> $GITHUB_ENV

          # publish LD_LIBRARY_PATH fragment referencing the env lib dir
          echo "LD_LIBRARY_PATH=${ENV_PREFIX}/lib:\$LD_LIBRARY_PATH" >> $GITHUB_ENV
        shell: bash -l {0}

      - name: Install pip requirements (allow pip-install of rdkit/openbabel/vina)
        run: |
          if [ -f requirements.txt ]; then
            # Do NOT let pip overwrite openmm/pdbfixer installed by conda.
            # We allow rdkit/openbabel/vina to be installed via pip from requirements.txt.
            grep -vE '^(openmm|pdbfixer)' requirements.txt > reqs-pip.txt || true
            conda run -n "${CONDA_ENV_NAME}" --no-capture-output python -m pip install --upgrade pip
            conda run -n "${CONDA_ENV_NAME}" --no-capture-output python -m pip install -r reqs-pip.txt
          fi
        shell: bash -l {0}

      - name: Install pytest (minimal test dependency)
        run: |
          # Ensure pip is up-to-date inside the conda env and install pytest
          conda run -n "${CONDA_ENV_NAME}" --no-capture-output python -m pip install --upgrade pip
          conda run -n "${CONDA_ENV_NAME}" --no-capture-output python -m pip install pytest
        shell: bash -l {0}

      - name: Verify python & pytest inside conda env (debug)
        run: |
          echo "ENV_PREFIX=$ENV_PREFIX"
          conda run -n "${CONDA_ENV_NAME}" --no-capture-output bash -lc 'echo "python -> $(which python)"; python -V; echo "pytest -> $(which pytest 2>/dev/null || true)"; python -m pytest --version || true'
        shell: bash -l {0}

      - name: Lint with flake8
        run: |
          conda run -n "${CONDA_ENV_NAME}" --no-capture-output python -m pip install flake8
          conda run -n "${CONDA_ENV_NAME}" --no-capture-output python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          if [ -x ./lint.sh ]; then ./lint.sh || true; fi
        shell: bash -l {0}

      - name: Run tests (pytest) â€” robust: use env python
        run: |
          # Ensure runtime uses conda env lib dir and run tests inside the env.
          # Use python -m pytest to avoid relying on the pytest executable being on PATH.
          conda run -n "${CONDA_ENV_NAME}" --no-capture-output bash -lc 'export LD_LIBRARY_PATH="${ENV_PREFIX}/lib:${LD_LIBRARY_PATH:-}"; \
            echo "Running tests with: $(python -V) at $(which python)"; \
            python -m pytest -q'
        shell: bash -l {0}
